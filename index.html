<!DOCTYPE html>
<html>
<head>
  <title>¿Quién es el Impostor?</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background-color: #121212; color: #f1f1f1; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #555; }
  </style>
</head>
<body>
  <h1>¿Quién es el Impostor?</h1>
  <div id="lobby">
    <input id="nombre" placeholder="Tu nombre" />
    <button onclick="entrarLobby()">Entrar</button>
  </div>
  <div id="juego" class="hidden">
    <h2 id="jugadorAsignado"></h2>
    <div id="mensaje"></div>
    <div id="votacion"></div>
    <div id="liderControls" class="hidden">
      <button onclick="iniciarJuego()">Iniciar Partida</button>
      <button onclick="finalizarPartida()">Finalizar Partida</button>
      <button onclick="reiniciarJuego()">Reiniciar Partida</button>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC75hIhVE6SYEuyGiR44Q2VqEzyGQeu-mI",
      authDomain: "impostorr-e087b.firebaseapp.com",
      databaseURL: "https://impostorr-e087b-default-rtdb.firebaseio.com",
      projectId: "impostorr-e087b",
      storageBucket: "impostorr-e087b.appspot.com",
      messagingSenderId: "94911572425",
      appId: "1:94911572425:web:b23187ef0213eb443c6018",
      measurementId: "G-VKYKF342DN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const jugadoresFamosos = ["Messi", "Cristiano Ronaldo", "Mbappé", "Neymar", "Haaland", "Modric", "Vinicius", "Griezmann", "De Bruyne", "Bellingham", "Lewandowski", "Benzema", "Dybala", "Di María", "Courtois", "Salah", "Kane", "Foden", "Sané", "Musiala", "Alisson", "Kimmich", "Pedri", "Gavi", "João Félix", "Rashford", "Sterling", "Rodri", "Araujo", "Martínez", "Valverde", "Chiesa", "Vlahovic", "Onana", "Mendy", "Akanji", "Grealish", "Lautaro", "Otamendi", "Enzo Fernández", "Julián Álvarez", "Walker", "Maguire", "Varane", "Pogba", "Hakimi", "Ziyech", "Koulibaly", "Saka", "Odegaard", "Son", "Tadic", "Bonucci", "Jorginho", "Locatelli", "Reus", "Kroos", "Hummels", "Ter Stegen", "Busquets", "Piqué", "Alba", "Rüdiger", "Mount", "Chilwell", "Fofana", "Zinchenko", "Martial", "Trent Alexander-Arnold", "Robertson", "Gakpo", "Luiz Díaz", "Núñez", "Casemiro", "Richarlison", "Antony", "Danilo", "Gundogan", "Laporte", "Torres", "Morata", "Ansu Fati", "Pulisic", "Dest", "McKennie", "Reyna", "Davies", "Jonathan David", "Cuadrado", "James Rodríguez", "Suárez", "Cavani", "Filipe Luís", "David Luiz", "Thiago Silva", "Gabriel Jesus", "Fred", "Raphinha", "Militao", "Tchouaméni", "Camavinga", "Navas", "Bravo", "Isco", "Asensio", "Illarramendi", "Alaba", "Weghorst", "Depay", "Blind", "Klaassen", "Malacia", "Schuurs", "De Ligt", "Van Dijk", "Berghuis", "Zlatan Ibrahimović", "Eriksen", "Delaney", "Schmeichel", "Cornelius", "Højlund", "Oblak", "Savic", "Kostic", "Mitrovic", "Szczesny", "Zielinski", "Lewy", "Piatek", "Modeste", "Giroud", "Coman", "Rabiot", "Tolisso", "Ben Yedder", "Kolo Muani", "Upamecano", "Konaté", "Nkunku", "Thuram", "Dembele", "Umtiti", "Areola", "Mandanda", "Trapp", "Baumgartner", "Sabitzer", "Arnautović", "Dragovic", "Kalajdzic", "Sorloth", "Haaland", "Ødegaard", "Berge", "King", "Brahimi", "Marega", "Slimani", "Mahrez", "Feghouli"];

    let nombre = "";
    let esLider = false;
    let partidaActiva = false;

    function entrarLobby() {
      nombre = document.getElementById("nombre").value.trim();
      if (!nombre) return alert("Poné tu nombre");

      db.ref("jugadores/" + nombre).set({ conectado: true });

      db.ref("jugadores").once("value", snap => {
        if (!snap.exists()) esLider = true;
        document.getElementById("lobby").classList.add("hidden");
        document.getElementById("juego").classList.remove("hidden");
        if (esLider) document.getElementById("liderControls").classList.remove("hidden");
      });

      window.addEventListener("beforeunload", () => {
        db.ref("jugadores/" + nombre).remove();
      });

      db.ref("partida/resultado").on("value", snap => {
        const res = snap.val();
        if (res) {
          document.getElementById("mensaje").innerText = res;
          mostrarBotonReiniciar();
          partidaActiva = false;
        }
      });

      db.ref("partida/estado").on("value", snap => {
        if (snap.val() === "finalizada") {
          document.getElementById("votacion").innerHTML = "";
          db.ref("partida/resultado").once("value", r => {
            document.getElementById("mensaje").innerText = r.val();
            mostrarBotonReiniciar();
          });
        }
      });
    }

    function iniciarJuego() {
      db.ref("jugadores").once("value", snap => {
        const lista = Object.keys(snap.val() || {});
        if (lista.length < 3) return alert("Mínimo 3 jugadores");

        const jugadorElegido = jugadoresFamosos[Math.floor(Math.random() * jugadoresFamosos.length)];
        const impostor = lista[Math.floor(Math.random() * lista.length)];

        lista.forEach(j => {
          const rol = j === impostor ? "IMPOSTOR" : "TRIPULANTE";
          db.ref("jugadores/" + j + "/partida").set(rol);
        });

        db.ref("partida/jugador").set(jugadorElegido);
        partidaActiva = true;
        mostrarVotacion();

        db.ref("jugadores/" + nombre + "/partida").once("value", snap => {
          const miRol = snap.val();
          document.getElementById("jugadorAsignado").innerText =
            miRol === "IMPOSTOR" ? "Sos el IMPOSTOR. Descubrí quién es el jugador." :
            `Jugador: ${jugadorElegido}`;
        });
      });
    }

    function mostrarVotacion() {
      db.ref("jugadores").once("value", snap => {
        const lista = Object.keys(snap.val() || {});
        const container = document.getElementById("votacion");
        container.innerHTML = "<h3>¿Quién es el impostor?</h3>";
        lista.forEach(j => {
          if (j !== nombre) {
            const btn = document.createElement("button");
            btn.innerText = j;
            btn.onclick = () => votar(j);
            container.appendChild(btn);
          }
        });
      });
    }

    function votar(aQuien) {
      db.ref("votos/" + nombre).once("value", snap => {
        if (snap.exists()) return alert("Ya votaste");
        db.ref("votos/" + nombre).set(aQuien);
        document.getElementById("mensaje").innerText = `Votaste a ${aQuien}`;
      });
    }

    function finalizarPartida() {
      partidaActiva = false;
      db.ref("votos").once("value", snap => {
        const votos = snap.val() || {};
        const cuenta = {};
        Object.values(votos).forEach(v => cuenta[v] = (cuenta[v] || 0) + 1);
        let max = 0, expulsado = null;
        for (const j in cuenta) {
          if (cuenta[j] > max) {
            max = cuenta[j];
            expulsado = j;
          }
        }
        if (!expulsado) return db.ref("partida/resultado").set("No hubo votos.");

        db.ref("jugadores/" + expulsado + "/partida").once("value", rol => {
          const resultado = rol.val() === "IMPOSTOR"
            ? `¡El impostor (${expulsado}) fue expulsado! ¡Ganan los tripulantes!`
            : `Expulsaron a ${expulsado}, que no era impostor. ¡Gana el impostor!`;
          db.ref("partida/resultado").set(resultado);
          db.ref("partida/estado").set("finalizada");
        });
      });
    }

    function mostrarBotonReiniciar() {
      if (esLider) document.getElementById("liderControls").classList.remove("hidden");
    }

    function reiniciarJuego() {
      db.ref("votos").remove();
      db.ref("partida").remove();
      db.ref("jugadores").once("value", snap => {
        const jugadores = snap.val() || {};
        Object.keys(jugadores).forEach(j => {
          db.ref("jugadores/" + j + "/partida").remove();
        });
      });
      partidaActiva = false;
      document.getElementById("mensaje").innerText = "";
      document.getElementById("votacion").innerHTML = "";
      document.getElementById("juego").classList.add("hidden");
      document.getElementById("lobby").classList.remove("hidden");
      if (esLider) document.getElementById("liderControls").classList.remove("hidden");
    }
  </script>
</body>
</html>
