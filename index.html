<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Impostor - FÃºtbol</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ El Impostor - FÃºtbol</h1>
  <div id="login">
    <input id="nombre" placeholder="Tu nombre" />
    <button onclick="unirse()">Unirse</button>
  </div>

  <div id="lobby" class="hidden">
    <h2>Lobby</h2>
    <div id="jugadores"></div>
    <div id="liderControls" class="hidden">
      <button onclick="iniciarJuego()">Iniciar partida</button>
      <button onclick="reiniciarJuego()">Reiniciar</button>
    </div>
  </div>

  <div id="juego" class="hidden">
    <h2 id="jugadorSeleccionado"></h2>
    <p id="mensaje"></p>
    <div id="votacion"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC75hIhVE6SYEuyGiR44Q2VqEzyGQeu-mI",
      authDomain: "impostorr-e087b.firebaseapp.com",
      databaseURL: "https://impostorr-e087b-default-rtdb.firebaseio.com",
      projectId: "impostorr-e087b",
      storageBucket: "impostorr-e087b.appspot.com",
      messagingSenderId: "94911572425",
      appId: "1:94911572425:web:b23187ef0213eb443c6018",
      measurementId: "G-VKYKF342DN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const futbolistas = [
      "Lionel Messi", "Cristiano Ronaldo", "Neymar Jr.", "Kylian MbappÃ©", "Erling Haaland",
      "Robert Lewandowski", "Kevin De Bruyne", "Mohamed Salah", "Luka Modric", "Karim Benzema",
      "Sergio Ramos", "Manuel Neuer", "Harry Kane", "Virgil van Dijk", "Luis SuÃ¡rez",
      "Zlatan IbrahimoviÄ‡", "Paul Pogba", "Raheem Sterling", "Sadio ManÃ©", "Antoine Griezmann",
      "Luis Figo", "Ronaldinho", "Rivaldo", "Thierry Henry", "AndrÃ©s Iniesta",
      "Xavi HernÃ¡ndez", "Frank Lampard", "Steven Gerrard", "David Beckham", "Zinedine Zidane",
      "Paolo Maldini", "Roberto Carlos", "Cafu", "Johan Cruyff", "Diego Maradona",
      "PelÃ©", "George Best", "Bobby Charlton", "Gerd MÃ¼ller", "Ferenc PuskÃ¡s",
      "EusÃ©bio", "Michel Platini", "Marco van Basten", "JÃ¼rgen Klinsmann", "Franz Beckenbauer",
      "Didier Drogba", "KakÃ¡", "Luis Enrique", "Carlos Tevez", "RaÃºl GonzÃ¡lez",
      "David Villa", "Fernando Torres", "Iker Casillas", "Marcelo", "Thiago Silva",
      "Ãngel Di MarÃ­a", "Gareth Bale", "Paul Scholes", "Andriy Shevchenko", "Nemanja VidiÄ‡",
      "Diego ForlÃ¡n", "Robin van Persie", "Arjen Robben", "James RodrÃ­guez", "Juan Mata",
      "Mesut Ã–zil", "Ã‰ric Cantona", "Claude MakÃ©lÃ©lÃ©", "Philipp Lahm", "Bastian Schweinsteiger",
      "Thomas MÃ¼ller", "Mats Hummels", "Mario GÃ¶tze", "Toni Kroos", "Marc-AndrÃ© ter Stegen",
      "Alisson Becker", "Jan Oblak", "Ederson Moraes", "Thibaut Courtois", "Kalidou Koulibaly",
      "Trent Alexander-Arnold", "Jordan Henderson", "N'Golo KantÃ©", "Leroy SanÃ©", "Jadon Sancho",
      "Phil Foden", "Mason Mount", "Bukayo Saka", "Jude Bellingham", "VinÃ­cius Jr.",
      "Rodrygo", "Pedri", "Frenkie de Jong", "Gavi", "JoÃ£o FÃ©lix",
      "Bernardo Silva", "RÃºben Dias", "RaphaÃ«l Varane", "Edinson Cavani", "Ãlvaro Morata",
      "Marcelo", "Philippe Coutinho", "Sergio AgÃ¼ero", "Diego GodÃ­n", "Roberto Firmino",
      "JoÃ£o Cancelo", "Alexis SÃ¡nchez", "Timo Werner", "Hugo Lloris", "David Alaba",
      "Christian Eriksen", "Ivan RakitiÄ‡", "Gianluigi Buffon", "Wesley Sneijder", "Claudio Marchisio",
      "Marco Reus", "Ivan PeriÅ¡iÄ‡", "Gonzalo HiguaÃ­n", "James Milner", "Ashley Cole",
      "Cesc FÃ bregas", "Eden Hazard", "Lucas Moura", "Matthijs de Ligt", "Kalvin Phillips",
      "Rodri", "Bruno Fernandes", "Christian Pulisic", "Gianluigi Donnarumma", "Eduardo Camavinga",
      "Federico Valverde", "Achraf Hakimi", "Thiago AlcÃ¢ntara", "Marquinhos", "Sergio Busquets",
      "Gerard PiquÃ©", "Lucas HernÃ¡ndez", "Jordi Alba", "CÃ©sar Azpilicueta", "Juan Cuadrado"
    ];

    let nombreUsuario = "";
    let esLider = false;
    let partidaActiva = false;

    // Listeners globales para evitar mÃºltiples listeners duplicados
    let listenerJugadores = null;
    let listenerRol = null;
    let listenerVotos = null;

    function unirse() {
      nombreUsuario = document.getElementById("nombre").value.trim();
      if (!nombreUsuario) return alert("IngresÃ¡ tu nombre");

      const refJugadores = db.ref("jugadores");

      // AÃ±adir jugador y asignar lÃ­der si es el primero
      refJugadores.once("value", snap => {
        const jugadores = snap.val() || {};
        if (Object.keys(jugadores).length === 0) esLider = true;

        db.ref("jugadores/" + nombreUsuario).set({ nombre: nombreUsuario });
        document.getElementById("login").classList.add("hidden");
        document.getElementById("lobby").classList.remove("hidden");
        if (esLider) document.getElementById("liderControls").classList.remove("hidden");

        // Configurar listeners
        setupListeners();
      });

      // Quitar jugador al cerrar pestaÃ±a
      db.ref("jugadores/" + nombreUsuario).onDisconnect().remove();
    }

    function setupListeners() {
      if (listenerJugadores) listenerJugadores.off();
      listenerJugadores = db.ref("jugadores");
      listenerJugadores.on("value", snap => {
        const jugadores = snap.val() || {};
        document.getElementById("jugadores").innerHTML =
          Object.keys(jugadores).map(j => `<div>${j}</div>`).join("");
      });

      if (listenerRol) listenerRol.off();
      listenerRol = db.ref("jugadores/" + nombreUsuario + "/partida");
      listenerRol.on("value", snap => {
        const rol = snap.val();
        if (!rol) {
          // Volver al lobby si no tiene rol asignado
          document.getElementById("juego").classList.add("hidden");
          document.getElementById("lobby").classList.remove("hidden");
          if (esLider) document.getElementById("liderControls").classList.remove("hidden");
          partidaActiva = false;
          eliminarBotones();
          return;
        }
        // Mostrar pantalla de juego
        document.getElementById("lobby").classList.add("hidden");
        document.getElementById("juego").classList.remove("hidden");
        if (rol === "IMPOSTOR") {
          document.getElementById("jugadorSeleccionado").innerText = "No sabÃ©s quiÃ©n es el jugador. Sos el impostor ðŸ˜ˆ";
        } else {
          document.getElementById("jugadorSeleccionado").innerText = `El jugador es: ${rol}`;
        }
        partidaActiva = true;
        mostrarVotacion();
        if (esLider) mostrarBotonFinalizar();
      });

      if (listenerVotos) listenerVotos.off();
      listenerVotos = db.ref("votos");
      listenerVotos.on("value", snap => {
        const votos = snap.val() || {};
        const cuenta = {};
        Object.values(votos).forEach(voto => {
          cuenta[voto] = (cuenta[voto] || 0) + 1;
        });
        const resultado = Object.entries(cuenta).map(([jugador, cant]) =>
          `${jugador}: ${cant} voto${cant > 1 ? "s" : ""}`
        ).join("<br>");
        document.getElementById("mensaje").innerHTML = resultado;
      });
    }

    function iniciarJuego() {
      db.ref("jugadores").once("value", snap => {
        const jugadores = Object.keys(snap.val() || {});
        if (jugadores.length < 3) {
          alert("Se necesitan al menos 3 jugadores para iniciar.");
          return;
        }
        const futbolista = futbolistas[Math.floor(Math.random() * futbolistas.length)];
        const impostor = jugadores[Math.floor(Math.random() * jugadores.length)];

        // Limpiar votos y asignar roles
        db.ref("votos").remove();
        eliminarBotones();

        jugadores.forEach(j => {
          db.ref("jugadores/" + j + "/partida").set(j === impostor ? "IMPOSTOR" : futbolista);
        });

        db.ref("partida/jugador").set(futbolista);
        partidaActiva = true;
        mostrarVotacion();
        if (esLider) mostrarBotonFinalizar();
      });
    }

    function reiniciarJuego() {
      // Se elimina TODO menos jugadores, para conservar usuarios conectados
      db.ref("votos").remove();
      db.ref("partida").remove();
      // Se eliminan roles de los jugadores para volver al lobby
      db.ref("jugadores").once("value", snap => {
        const jugadores = snap.val() || {};
        Object.keys(jugadores).forEach(j => {
          db.ref("jugadores/" + j + "/partida").remove();
        });
      });

      partidaActiva = false;
      eliminarBotones();

      // Volver a lobby y permitir votar despuÃ©s del reinicio
      document.getElementById("juego").classList.add("hidden");
      document.getElementById("lobby").classList.remove("hidden");
      if (esLider) document.getElementById("liderControls").classList.remove("hidden");
    }

    function mostrarVotacion() {
      db.ref("jugadores").once("value", snap => {
        const jugadores = Object.keys(snap.val() || {});
        db.ref("votos/" + nombreUsuario).once("value", votoSnap => {
          if (votoSnap.exists()) {
            document.getElementById("votacion").innerHTML = `<p>Ya votaste. Gracias.</p>`;
          } else if (partidaActiva) {
            document.getElementById("votacion").innerHTML = jugadores.map(j =>
              `<button onclick="votar('${j}')" style="margin:3px;">Votar a ${j}</button>`
            ).join("<br>");
          } else {
            document.getElementById("votacion").innerHTML = `<p>Esperando inicio de partida...</p>`;
          }
        });
      });
    }

    function votar(nombre) {
      db.ref("votos/" + nombreUsuario).once("value", votoSnap => {
        if (votoSnap.exists()) {
          alert("Ya votaste");
          mostrarVotacion();
          return;
        }
        db.ref("votos/" + nombreUsuario).set(nombre);
      });
    }

    function mostrarBotonFinalizar() {
      if (!esLider || !partidaActiva) return;
      if (document.getElementById("finalizarBtn")) return; // Ya existe

      const botonFinalizar = document.createElement("button");
      botonFinalizar.id = "finalizarBtn";
      botonFinalizar.innerText = "Finalizar partida";
      botonFinalizar.style.marginTop = "15px";
      botonFinalizar.onclick = finalizarPartida;
      document.getElementById("juego").appendChild(botonFinalizar);
    }

    function eliminarBotones() {
      const btnFinalizar = document.getElementById("finalizarBtn");
      if (btnFinalizar) btnFinalizar.remove();
      const btnReiniciar = document.getElementById("reiniciarBtn");
      if (btnReiniciar) btnReiniciar.remove();
    }

    function mostrarBotonReiniciar() {
      if (document.getElementById("reiniciarBtn")) return;

      const botonReiniciar = document.createElement("button");
      botonReiniciar.id = "reiniciarBtn";
      botonReiniciar.innerText = "Reiniciar partida";
      botonReiniciar.style.marginTop = "15px";
      botonReiniciar.onclick = reiniciarJuego;
      document.getElementById("juego").appendChild(botonReiniciar);
    }

    function finalizarPartida() {
      partidaActiva = false;
      eliminarBotones();

      db.ref("votos").once("value", snap => {
        const votos = snap.val() || {};
        const cuenta = {};
        Object.values(votos).forEach(voto => {
          cuenta[voto] = (cuenta[voto] || 0) + 1;
        });

        let maxVotos = 0;
        let expulsado = null;
        for (const jugador in cuenta) {
          if (cuenta[jugador] > maxVotos) {
            maxVotos = cuenta[jugador];
            expulsado = jugador;
          }
        }

        if (!expulsado) {
          document.getElementById("mensaje").innerHTML = "No hubo votos. Nadie fue expulsado.";
          mostrarBotonReiniciar();
          return;
        }

        db.ref("jugadores/" + expulsado + "/partida").once("value", snapJugador => {
          const rol = snapJugador.val();
          let mensajeFinal = "";
          if (rol === "IMPOSTOR") {
            mensajeFinal = `Â¡El impostor (${expulsado}) fue expulsado! Â¡Ganaron los tripulantes! ðŸŽ‰`;
          } else {
            mensajeFinal = `Expulsaron a ${expulsado}, que no era el impostor. Â¡Gana el impostor! ðŸ˜ˆ`;
          }

          document.getElementById("mensaje").innerHTML = mensajeFinal;
          document.getElementById("votacion").innerHTML = "";

          mostrarBotonReiniciar();
        });
      });
    }
  </script>
</body>
</html>
