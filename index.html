<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Impostor - Fútbol</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>🎯 El Impostor - Fútbol</h1>
  <div id="login">
    <input id="nombre" placeholder="Tu nombre" />
    <button onclick="unirse()">Unirse</button>
  </div>

  <div id="lobby" class="hidden">
    <h2>Lobby</h2>
    <div id="jugadores"></div>
    <div id="liderControls" class="hidden">
      <button onclick="iniciarJuego()">Iniciar partida</button>
      <button onclick="reiniciarJuego()">Reiniciar</button>
    </div>
  </div>

  <div id="juego" class="hidden">
    <h2 id="jugadorSeleccionado"></h2>
    <p id="mensaje"></p>
    <div id="votacion"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC75hIhVE6SYEuyGiR44Q2VqEzyGQeu-mI",
      authDomain: "impostorr-e087b.firebaseapp.com",
      databaseURL: "https://impostorr-e087b-default-rtdb.firebaseio.com",
      projectId: "impostorr-e087b",
      storageBucket: "impostorr-e087b.appspot.com",
      messagingSenderId: "94911572425",
      appId: "1:94911572425:web:b23187ef0213eb443c6018",
      measurementId: "G-VKYKF342DN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Lista con jugadores mundialmente reconocidos
    const futbolistas = [
      "Lionel Messi", "Cristiano Ronaldo", "Neymar Jr.", "Kylian Mbappé", "Erling Haaland",
      "Robert Lewandowski", "Kevin De Bruyne", "Mohamed Salah", "Luka Modric", "Karim Benzema",
      "Sergio Ramos", "Manuel Neuer", "Harry Kane", "Virgil van Dijk", "Luis Suárez",
      "Zlatan Ibrahimović", "Paul Pogba", "Raheem Sterling", "Sadio Mané", "Antoine Griezmann",
      "Luis Figo", "Ronaldinho", "Rivaldo", "Thierry Henry", "Andrés Iniesta",
      "Xavi Hernández", "Frank Lampard", "Steven Gerrard", "David Beckham", "Zinedine Zidane",
      "Paolo Maldini", "Roberto Carlos", "Cafu", "Johan Cruyff", "Diego Maradona",
      "Pelé", "George Best", "Bobby Charlton", "Gerd Müller", "Ferenc Puskás",
      "Eusébio", "Michel Platini", "Marco van Basten", "Jürgen Klinsmann", "Franz Beckenbauer",
      "Drogba", "Kaka", "Luis Enrique", "Carlos Tevez", "Raúl González",
      "David Villa", "Fernando Torres", "Iker Casillas", "Marcelo", "Thiago Silva",
      "Ángel Di María", "Gareth Bale", "Paul Scholes", "Andriy Shevchenko", "Nemanja Vidić",
      "Diego Forlán", "Robin van Persie", "Arjen Robben", "James Rodríguez", "Juan Mata",
      "Mesut Özil", "Karim Benzema", "Éric Cantona", "Claude Makélélé", "Philipp Lahm",
      "Bastian Schweinsteiger", "Thomas Müller", "Mats Hummels", "Mario Götze", "Toni Kroos",
      "Marc-André ter Stegen", "Alisson Becker", "Jan Oblak", "Ederson Moraes", "Thibaut Courtois",
      "Kalidou Koulibaly", "Trent Alexander-Arnold", "Jordan Henderson", "N'Golo Kanté", "Raheem Sterling",
      "Leroy Sané", "Jadon Sancho", "Phil Foden", "Mason Mount", "Bukayo Saka",
      "Jude Bellingham", "Erling Haaland", "Vinícius Jr.", "Rodrygo", "Pedri",
      "Frenkie de Jong", "Gavi", "João Félix", "Bernardo Silva", "Rúben Dias",
      "Raphaël Varane", "Paul Pogba", "Edinson Cavani", "Álvaro Morata", "Kylian Mbappé",
      "Marcelo", "Coutinho", "Sergio Agüero", "Diego Godín", "Roberto Firmino",
      "Luis Alberto", "João Cancelo", "Alexis Sánchez", "Timo Werner", "Thomas Lemar",
      "Timo Werner", "Hugo Lloris", "David Alaba", "Gareth Bale", "Christian Eriksen",
      "Ivan Rakitić", "Neymar", "Manuel Neuer", "David Silva", "Dani Alves",
      "Gianluigi Buffon", "Wesley Sneijder", "Claudio Marchisio", "Marco Reus", "Ivan Perišić",
      "Gonzalo Higuaín", "James Milner", "Ashley Cole", "Cesc Fàbregas", "Eden Hazard",
      "Luka Modrić", "Mario Mandžukić", "Dani Carvajal", "Ángel Correa", "Lucas Moura",
      "Lucas Digne", "Miralem Pjanić", "Matthijs de Ligt", "Kalvin Phillips", "Rodri",
      "Bruno Fernandes", "Christian Pulisic", "Gianluigi Donnarumma", "Eduardo Camavinga",
      "Federico Valverde", "Achraf Hakimi", "Philippe Coutinho", "Mousa Dembélé", "Yaya Touré",
      "Karim Benzema", "Thiago Alcântara", "Marquinhos", "Sergio Busquets", "Marc-André ter Stegen",
      "Gerard Piqué", "Lucas Hernández", "Jordi Alba", "Raphaël Varane", "César Azpilicueta",
      "Jordi Alba", "Sergio Busquets", "Juan Cuadrado", "Javier Mascherano", "Thiago Silva"
    ];

    let nombreUsuario = "";
    let esLider = false;

    function unirse() {
      nombreUsuario = document.getElementById("nombre").value.trim();
      if (!nombreUsuario) return alert("Ingresá tu nombre");

      const ref = db.ref("jugadores");
      ref.once("value", snap => {
        const jugadores = snap.val() || {};
        if (Object.keys(jugadores).length === 0) esLider = true;

        db.ref("jugadores/" + nombreUsuario).set({ nombre: nombreUsuario });
        document.getElementById("login").classList.add("hidden");
        document.getElementById("lobby").classList.remove("hidden");
        if (esLider) document.getElementById("liderControls").classList.remove("hidden");
      });

      db.ref("jugadores").on("value", snap => {
        const jugadores = snap.val() || {};
        document.getElementById("jugadores").innerHTML =
          Object.keys(jugadores).map(j => `<div>${j}</div>`).join("");
      });

      // Eliminar jugador cuando cierra pestaña
      db.ref("jugadores/" + nombreUsuario).onDisconnect().remove();

      // Escuchar partida asignada
      db.ref("jugadores/" + nombreUsuario + "/partida").on("value", snap => {
        const jugador = snap.val();
        if (!jugador) return;
        document.getElementById("lobby").classList.add("hidden");
        document.getElementById("juego").classList.remove("hidden");
        if (jugador === "IMPOSTOR") {
          document.getElementById("jugadorSeleccionado").innerText = "No sabés quién es el jugador. Sos el impostor 😈";
        } else {
          document.getElementById("jugadorSeleccionado").innerText = `El jugador es: ${jugador}`;
        }
        mostrarVotacion();
      });
    }

    function iniciarJuego() {
      db.ref("jugadores").once("value", snap => {
        const jugadores = Object.keys(snap.val() || {});
        const futbolista = futbolistas[Math.floor(Math.random() * futbolistas.length)];
        const impostor = jugadores[Math.floor(Math.random() * jugadores.length)];

        // Limpiar votos anteriores
        db.ref("votos").remove();

        jugadores.forEach(j => {
          db.ref("jugadores/" + j + "/partida").set(j === impostor ? "IMPOSTOR" : futbolista);
        });

        db.ref("partida/jugador").set(futbolista);
      });
    }

    function reiniciarJuego() {
      db.ref().set(null);
      location.reload();
    }

    function mostrarVotacion() {
      db.ref("jugadores").once("value", snap => {
        const jugadores = Object.keys(snap.val() || {});
        db.ref("votos/" + nombreUsuario).once("value", votoSnap => {
          if (votoSnap.exists()) {
            // Ya votó, mostrar mensaje
            document.getElementById("votacion").innerHTML = `<p>Ya votaste. Gracias.</p>`;
          } else {
            // Puede votar
            document.getElementById("votacion").innerHTML = jugadores.map(j =>
              `<button onclick="votar('${j}')" style="margin:3px;">Votar a ${j}</button>`
            ).join("<br>");
          }
        });
      });
    }

    function votar(nombre) {
      // Solo votar si no votó antes
      db.ref("votos/" + nombreUsuario).once("value", votoSnap => {
        if (votoSnap.exists()) {
          alert("Ya votaste");
          mostrarVotacion();
          return;
        }
        db.ref("votos/" + nombreUsuario).set(nombre);
      });
    }

    db.ref("votos").on("value", snap => {
      const votos = snap.val() || {};
      // Contar votos por jugador
      const cuenta = {};
      Object.values(votos).forEach(voto => {
        cuenta[voto] = (cuenta[voto] || 0) + 1;
      });
      const resultado = Object.entries(cuenta).map(([jugador, cant]) =>
        `${jugador}: ${cant} voto${cant > 1 ? "s" : ""}`
      ).join("<br>");
      document.getElementById("mensaje").innerHTML = resultado;
    });
  </script>
</body>
</html>
